# SSH

> <https://wangdoc.com/ssh/basic.html>

SSH（Secure Shell 的缩写）是一种网络协议，用于加密两台计算机之间的通信，并且支持各种身份验证机制。

SSH 软件分成两个部分：向服务器发出请求的部分，称为客户端（client），OpenSSH 的实现为 ssh；接收客户端发出的请求的部分，称为服务器（server），OpenSSH 的实现为 sshd。

## SSH客户端

ssh 连接远程服务器后，首先有一个验证过程，验证远程服务器是否为陌生地址。ssh 会将本机连接过的所有服务器公钥的指纹，都储存在本机的~/.ssh/known_hosts文件中。

SSH 连接的握手阶段，客户端必须跟服务端约定加密参数集。如：
`TLS_RSA_WITH_AES_128_CBC_SHA`的含义如下：

- TLS：加密通信协议
- RSA：密钥交换算法
- AES：加密算法
- 128：加密算法的强度
- CBC：加密算法的模式
- SHA：数字签名的 Hash 函数

SSH 客户端的全局配置文件是/etc/ssh/ssh_config，用户个人的配置文件在~/.ssh/config，优先级高于全局配置文件。

## 密钥登录

SSH 默认采用密码登录，但密钥登录是更好的解决方案。

密钥（key）是一个非常大的数字，通过加密算法得到。对称加密只需要一个密钥，非对称加密需要两个密钥成对使用，分为公钥和私钥。

SSH 密钥登录采用的是非对称加密。其中，私钥必须私密保存，公钥则是公开的，可以对外发送。公钥和私钥是一一对应的。

如果数据使用公钥加密，那么只有使用对应的私钥才能解密，其他密钥都不行；反过来，如果使用私钥加密（这个过程一般称为“签名”），也只有使用对应的公钥解密。

SSH 密钥登录分为以下步骤：

- 客户端通过ssh-keygen生成自己的公钥和私钥。
- 手动将客户端的公钥放入远程服务器的指定位置。
- 客户端向服务器发起 SSH 登录的请求。
- 服务器收到用户 SSH 登录的请求，发送一些随机数据给用户，要求用户证明自己的身份。
- 客户端收到服务器发来的数据，使用私钥对数据进行签名，然后再发还给服务器。
- 服务器收到客户端发来的加密签名后，使用对应的公钥解密，然后跟原始数据比较。如果一致，就允许用户登录。

## SSH服务器

sshd 的配置文件在/etc/ssh目录，主配置文件是sshd_config。

sshd 有自己的一对或多对密钥。它使用密钥向客户端证明自己的身份。

sshd配置项：<https://wangdoc.com/ssh/server.html#sshd-%E9%85%8D%E7%BD%AE%E9%A1%B9>

## 端口转发

SSH 除了登录服务器，还有一大用途，就是作为加密通信的中介，充当两台服务器之间的通信加密跳板，使得原本不加密的通信变成加密通信。这个功能称为端口转发（port forwarding），又称 SSH 隧道（tunnel）。

端口转发有三种使用方法：动态转发，本地转发，远程转发。

**动态转发**：本机与 SSH 服务器之间创建了一个加密连接，然后本机内部针对某个端口的通信，都通过这个加密连接转发。它的一个使用场景就是，访问所有外部网站，都通过 SSH 转发。

`ssh -D 2121 tunnel-host -N`

命令中，-D表示动态转发，2121是本地端口，tunnel-host是 SSH 服务器，-N表示这个 SSH 连接只进行端口转发，不登录远程 Shell，不能执行远程命令，只能充当隧道。

这种转发采用了 SOCKS5 协议。访问外部网站时，需要把 HTTP 请求转成 SOCKS5 协议，才能把本地端口的请求转发出去。下面是 SSH 隧道建立后的一个使用实例：
`curl -x socks5://localhost:2121 http://www.example.com`

**本地转发**（local forwarding）：SSH 服务器作为中介的跳板机，建立本地计算机与特定目标网站之间的加密连接。

它会指定一个本地端口（local-port），所有发向那个端口的请求，都会转发到 SSH 跳板机（tunnel-host），然后 SSH 跳板机作为中介，将收到的请求发到目标服务器（target-host）的目标端口（target-port）。

`ssh -L local-port:target-host:target-port tunnel-host`
命令中，-L参数表示本地转发，local-port是本地端口，target-host是你想要访问的目标服务器，target-port是目标服务器的端口，tunnel-host是 SSH 跳板机。

例如`ssh -L 1100:mail.example.com:110 other.example.com -N`命令执行后，访问本机的1100端口，就是访问www.example.com的110端口。
采用上面的中介方式，只有本机到other.example.com的这一段是加密的，other.example.com到mail.example.com的这一段并不加密。

**远程转发**指的是在远程 SSH 服务器建立的转发规则。它跟本地转发正好反过来。

`ssh -R remote-port:target-host:target-port -N remotehost`
命令中，-R参数表示远程端口转发，remote-port是远程计算机的端口，target-host和target-port是目标服务器及其端口，remotehost是远程计算机。

一个例子是内网某台服务器localhost在 80 端口开了一个服务，可以通过远程转发将这个 80 端口，映射到具有公网 IP 地址的my.public.server服务器的 8080 端口，使得访问my.public.server:8080这个地址，就可以访问到那台内网服务器的 80 端口。

两个端口转发的实例：

1. VPN：用来在外网与内网之间建立一条加密通道。内网的服务器不能从外网直接访问，必须通过一个跳板机，如果本机可以访问跳板机，就可以使用 SSH 本地转发，简单实现一个 VPN。
2. 多级跳板：端口转发可以有多级，比如新建两个 SSH 隧道，第一个隧道转发给第二个隧道，第二个隧道才能访问目标服务器。

## SSH证书登录

SSH 一般情况下都采用密码登录或密钥登录。但SSH 还有第三种登录方法，就是证书登录。

证书颁发机构（Certificate Authority，简称 CA），对信任的服务器颁发服务器证书，对信任的用户颁发用户证书。

SSH 证书登录之前，如果还没有证书，需要生成证书。具体方法是：

1. 用户和服务器都将自己的公钥，发给 CA
2. CA 使用服务器公钥，生成服务器证书，发给服务器
3. CA 使用用户的公钥，生成用户证书，发给用户

有了证书后登录过程：

1. 用户登录服务器时，SSH 自动将用户证书发给服务器。
2. 服务器检查用户证书是否有效，以及是否由可信的 CA 颁发。
3. SSH 自动将服务器证书发给用户。
4. 用户检查服务器证书是否有效，以及是否由信任的 CA 颁发。
5. 双方建立连接，服务器允许用户登录。

## 常用命令

scp 是 secure copy 的缩写，相当于cp命令 + SSH。它的底层是 SSH 协议，默认端口是22，相当于先使用ssh命令登录远程主机，然后再执行拷贝操作。
`scp source destination` 命令中，source是文件当前的位置，destination是文件所要复制到的位置。

rsync （不是SSH工具集的一部分）用于文件同步。可以在本地计算机与远程计算机之间，或者两个本地目录之间同步文件。与其他文件传输工具（如 FTP 或 scp）不同，rsync 的最大特点是会检查发送方和接收方已有的文件，仅传输有变动的部分。

sftp 是 SSH 提供的一个客户端应用程序，主要用来安全地访问 FTP。因为 FTP 是不加密协议，很不安全，sftp就相当于将 FTP 放入了 SSH。
