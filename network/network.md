# Network

参考 [计算机网络](https://www.icourse163.org/learn/HIT-154005?tid=1467035449#/learn/content?type=detail&id=1247414653)

网络协议(network protocol): 为进行网络中的数据交换而建立的规则，标准或约定。

网络核心 关键功能：路由 + 转发
- 路由：确定分组从源到目的的传输路径 -- 路由算法
- 转发：将分组从路由器输入端口交换至正确的输出端口

Internet结构：
- 一级ISP
- 二级/三级ISP
- 区域ISP
- 接入ISP

接入网络：
- DSL（电话线）：FDM频分多路复用：10-1000kHz 下行；4-50kHz上行；0-4kHz传统电话
- 电缆网络（有线电视）：FDM
- 无线
  - 局域无线LAN：wifi
  - 广域无线：蜂窝网，4G，5G

网络核心：路由 + 转发

交换：
- 电路交换：独占资源 -> 多路复用
- 报文交换(message switching)：发送信息整体
- 分组交换(package switching)：将报文拆分为数据包
  
多路复用(Multiplexing)：
- FDM：频分多路复用：通过频率划分信号
- TDW：时分多路复用：用户在TDM帧中占用固定序号的时隙
- CDM：码分多路复用（常用于无线链路共享）：
  - 每个用户分配唯一的m比特码片序列
  - 用其码片序列编码数据
  - 要求：各个用户码片序列相互正交

网络性能：
- 速率：单位时间（秒）传输比特量，如 MB/s
- 带宽：原指信号最高频率与最低频率之差，Hz；网络带宽指数字信道最大速率，MB/s
- 延迟
- 吞吐率：在发送端和接收端之间传送数据速率，取决于瓶颈链路
  - 及时吞吐率
  - 平均吞吐率

OSI参考模型：
- 应用层 Application
  - 常见应用层服务：FTP, SMTP, HTTP
- 表示层 Presentation
  - 数据表示转换（主机独立编码 - 主机相关编码）
  - 加密解密
  - 压缩解压缩
  - 通常表示层也不独立存在
- 会话层 Session
  - 对话控制，同步
  - 通常回话层通常不单独存在
- 传输层 Transport
  - 报文分段和重组
  - SAP寻址：确保交给正确进程，如端口号
  - 连接/流量/差错控制
- 网络层 Network
  - 逻辑寻址（可能跨越多个网络，全局唯一逻辑地址）
  - 路由
  - 分组转发
- 数据链路层 Data link
  - 组帧
  - 物理寻址
  - 流量控制
  - 差错控制
- 物理层 Physical （解决单一比特传输问题）
  - 比特编码
  - 比特同步
  - 传输模式：单工，半双工，全双工

TCP/IP参考模型
- 应用层
- 传输层
- 网际层
- 网络接口层

5层参考模型：（综合OSI和TCP/IP）
- 应用层：FTP, HTTP
- 传输层：TCP, UDP
- 网络层：IP协议，路由协议
- 数据链路层
- 物理层：比特传输

交换机只包括 物理层和数据链路层。
路由器包括 物理层，数据链路层以及网络层。

## 应用层
进程间通信利用socket发送/接受消息。

应用层协议内容：
- 消息的类型
- 消息的语法，格式
- 字段语义
- 规则

### HTTP协议

使用TCP传输服务

RTT(RoundTripTime)：客户-服务器-客户往返时间

请求中加入参数：
GET：在URL字段？之后加入参数信息
POST：放在请求的消息体中

Cookie：为解决HTTP协议无状态问题
- 加入到HTTP请求的头部行中
- cookie文件由客户端浏览器管理
- 存入服务器后台数据库

缓存/代理服务器：
- Client向代理服务器发送所有请求
- 代理服务器向server发送HTTP请求，将结果返回Client并缓存该结果
- 条件性GET(if-modified-since: \<date\>)：代理服务器向Server发送条件性GET确定是缓存否为最新对象，如果是，则Server响应不包含对象。

### SMTP

消息格式：header + body

邮件访问协议：POP，IMAP， HTTP

### DNS

域名，IP地址转换；别名；负载均衡

分层次数据库：根服务器 - com域名解析服务器 - amazon.com域名解析服务器

每个ISP有一个本地域名服务器，作为代理服务器。

### Socket编程

进程创建套接字，会分配一个数据结构，存储该套接字相关信息。

常用函数：
- bind：绑定socket本地断点地址
- listen：置服务端流套接字于监听状态 （仅用于TCP）
- connect：使客户端socket与特定addr连接
- accept：从监听状态的流套接字连接请求队列中取出一个请求，并创建一个新的套接字建立连接通道
- send/sendto
- recv/recvfrom

常见数据转换：
- 网络字节顺序转换：socket API相关参数都需要转为网络字节顺序，涉及到网络字节顺序和本地字节顺序的相互转换，htos，ntos，htol，ntol
- IP地址 32位 与 点分十进制 转换
- 服务名 与 端口号 转换
- 协议名 与 协议号 转换


## 传输层

主要功能：
- 多路复用
- 可靠数据传输机制
- 流量控制
- 拥塞控制

### 多路复用：
发送：从多个socket接收数据，为每块数据封装对应头部信息，生成segment
接收：根据头部信息将收到的segment交给正确的进程

### 可靠数据传输：（不错，不丢，不乱）

初始策略：
ACK：接收方显式告知发送方分组已正确接收
NAK：告知分组有错误

> ACK/NAK发生错误？

重传，并添加序列号。接收方丢弃重复序列号。

> 可否取消NAK？

在ACK中加入被确认分组的序列号。

> 信道既可能发生错误，也可能丢失分组？

发送方等待合理时间后重传 - 定时器

> 性能差，每次发送都需要等待至少两个RTT？

收到ACK前发送多个分组 -> 流水线机制，滑动窗口协议（GBN，SP）

### TCP流量控制

> 防止接收方处理不了过多数据

接收方通过segment头部字段将recieveWindow告诉发送方。

### 拥塞控制

> 防止中间网络处理不了过多数据

感知网络拥塞：loss事件（timeout或3个重复ACK） 

加性增乘性减：发生loss后将窗口减半。

为加快速度，可采用阈值前窗口指数增长，阈值后线性增长。


### 三次握手/四次挥手
三次握手：
1. Client -> SYN=1，client初始序列号 -> server
2. server -> SYN ACK，server初始序列号 -> client
3. client -> ACK, (data) -> server

四次挥手：
1. client -> FIN -> server
2. server -> ACK, FIN -> client
3. client -> ACK -> server
4. server收到ACK，关闭连接


## 网络层

网络层不是端到端：路由器也会运行网络层协议。

主要功能：
- 转发：将分组从路由器输入端口转移到合适的输出端口 -> 转发表
- 路由：确定分组从源到目的经过的路径
- 连接建立

即路由算法确定端到端的路径，由此确定的路由信息就记录在转发表中。

网络层服务模型：
- 无连接服务：（如数据报网络）
  - 每个分组独立确定传输路径
  - 不同分组可能传输路径不同
- 连接服务：（如虚电路网络）
  - 事先确定路径（建立连接）
  - 分组传输路径相同
  - 传输结束后拆除
  
虚电路网络：
- 每个分组携带虚电路标识，而非目的主机地址 -- 虚电路转发表
- 每个虚电路经过的网络设备，都需要维护虚电路连接状态
- 每段链路的虚电路号可能不一样，路由器可能需要修改虚电路号

数据报网络：
- 每个分组需携带目的地址
- 每个分组独立选路

### IP协议

网络链路存在最大传输单元MTU：链路层数据可封装数据的上限。

不同链路MTU不一样。

大IP分组向较小MTU链路转发时，可以被分片：
- 一个IP分组分为多片IP分组
- IP分片到达目的主机后重组（根据IP数据报中标识和片偏移重组）

IP编址：
- 32比特（IPv4），常表示为点分十进制：192.12.3.127
- 网络号（高比特部分）和 主机号（低比特部分）两部分

IP子网：
- IP地址网络号相同
- 不跨越路由器可以物理联通

有类编址：
- A类网络：第一位为0，前8位为网络号: 0.0.0.0 - 127.255.255.255
- B类网络：前两位为10，前16位为网络号: 128.0.0.0 - 191.255.255.255
- C类网络：前三位为110，前24位为网络号: 192.0.0.0 - 223.255.255.255
- D类网络：前四位为1110，不区分网络号和主机号：特殊用途，如多播地址: 224.0.0.0 - 239.255.255.255
- E类网络：前四位为1111，不区分网络号与主机号：保留: 240.0.0.0 - 255.255.255.255

特殊IP地址：
- 网络号全0，主机号全0：在本网范围内表示本机，在路由表中表示默认路由
- 网络号全0：表示本网内某个特定主机
- 网络号全1，主机号全1：本网内广播地址
- 主机号全0：网络地址，表示一个网络
- 主机号全1：对特定网络进行广播
- 网络号127：环回地址，用于本地软件测试

私有IP地址：
- A类：网络号10
- B类：网络号172.16 - 172.31
- C类：网络号192.168.0 - 192.168.255
- 因为是私有网络，因此可以重复使用

子网划分：
- 网络号，子网号（原主机号部分比特），主机号
- 子网掩码：网络号和子网号全取1，主机号全0 -> 由此确认子网大小
- 将IP地址与子网掩码按位与计算，可以提取子网地址

如何获得IP地址：
- 静态配置
- 动态主机配置协议DHCP

DHCP：
- 从DHCP服务器动态获取IP地址，子网掩码等信息
- 允许地址重用
- 支持移动用户加入
- DHCP协议在应用层实现

网络地址转换（NAT）：
- IP地址不足，内部网络使用私有地址
- 内部网络IP变更，无需通告外界
- 内部设备对外部不可见
  
NAT实现：
- 替换每个IP数据报的IP地址和端口号
- 将替换信息存储在NAT转换表中
  
ICMP：
- 支持主机和路由器的差错报告
- 网络探寻
- 通过发送ICMP报文实现

ICMP报文：
- 差错报告报文
  - 目的不可达
  - 源抑制
  - 超时，TTL过期
  - 参数问题
  - 重定向
- 网络探寻报文
  - 回声请求，如ping
  - 时间戳请求

ICMP应用：traceroute
- 源主机向目的主机发送一系列UDP数据报
  - 第一组数据报TTL为1
  - 第二组TTL为2，以此类推
  - 目的端口号为不可能使用的端口号
- TTL过期后，路由器丢弃数据报，并向源主机发送ICMP报文，ICMP携带路由器名和IP地址信息
- ICMP报文返回源主机时，记录RTT
- 当源主机接收到目的端口不可达的ICMP报文时结束

IPv6：
- IP地址为128位
- 数据报不允许分片
- 校验和被移除
- 不再使用掩码 -> CIDR

### 路由算法

静态路由：
- 手工配置
- 更新慢

动态路由
- 基于路由算法计算路由信息
- 更新快

> 是否掌握整个网络的拓扑和费用信息

链路状态路由算法：
- Dijkstra算法 （需要避免震荡问题）

距离向量路由算法：
- Bellman-Ford算法

实际网络规模过大 -> 抽象为图不可行 -> 层次路由（划分为各个子区域（自治系统），在自治系统中运行各自的路由算法）

网关路由器：位于自治系统边缘，处理跨越自治系统的信息交换。
自治系统内路由 & 自治系统间路由

路由算法：确定分组传输路径
路由协议：路由器用来完成路由表建立和路由信息更新的通信协议

常见自治系统内部路由协议：（略过）
- RIP
- OSPF
- BGP

## 数据链路层

负责通过一条链路的一个节点向另一个物理链路直接相连的相邻节点传送数据报。




